# MIA POS eComm Protocol Overview

This document provides a detailed explanation of the **MIA POS eComm** protocol and the steps necessary to integrate it into merchant systems.

---

## Additional Documentation

- [API Documentation (download and open in browser)](../mia-ecomm-api_v0.0.1.html)
- [Signature Verification Guide](./signature-verification.md)

---

## Payment Flow

### **1. Initial Configuration**

To begin integration with MIA POS eComm, the merchant must configure the following parameters in their system:

- **merchantId**: The unique identifier for the merchant.
- **secretKey**: The secret key for authentication.
- **terminalId**: The terminal ID used for processing payments.
- **language**: The language of the payment interface (e.g., `en`, `ru`, `ro`).
- **paymentType**: The type of payment (`qr` for QR code or `rtp` for Request to Pay).
- **ecommBaseUrl**: The base URL for the MIA POS API (e.g., `https://ecomm-test.miapos.md`).

---

### **2. Collecting Order Information**

Before initiating the payment process, the merchant must collect the following order details:

- **orderId**: A unique identifier for the order (generated by the merchant).
- **amount**: The payment amount (in decimal format, e.g., `100.00`).
- **currency**: The currency of the payment (e.g., `MDL`).
- **payDescription**: A description of the payment (e.g., `Payment for Order #123`).
- **clientName**: (Optional) The client's name.
- **clientPhone**: (Optional) The client's phone number.
- **clientEmail**: (Optional) The client's email address.

---

### **3. Initiating the Payment**

When the client clicks the "Pay with MIA" button in the online store, the following steps are executed on the merchant's backend:

#### **3.1. Obtaining an Access Token**

If the merchant does not have a `refreshToken`, they must request an `accessToken` and `refreshToken` by using the following endpoint:

- **Method:** `POST`
- **Endpoint:** `/ecomm/api/v1/token`

#### **3.2. Refreshing the Access Token**

If the merchant already has a `refreshToken`, they can refresh the `accessToken` by using the following endpoint:

- **Method:** `POST`
- **Endpoint:** `/ecomm/api/v1/token/refresh`

#### **3.3. Registering the Payment**

After obtaining the `accessToken`, the merchant must register the payment using the following endpoint:

- **Method:** `POST`
- **Endpoint:** `/ecomm/api/v1/pay`

The client will be redirected to the `checkoutPage` URL to complete the payment.

---

### **4. Handling Payment Results**

#### **4.1. Failed Payment**

If the payment fails, the client will be redirected to the `failUrl`. In this case, the merchant can check the payment status using the following endpoint:

- **Method:** `GET`
- **Endpoint:** `/ecomm/api/v1/payment/{paymentId}`

#### **4.2. Successful Payment**

If the payment is successful, the client will be redirected to the `successUrl`. The merchant must verify the payment status using the same endpoint:

- **Method:** `GET`
- **Endpoint:** `/ecomm/api/v1/payment/{paymentId}`

---

### **5. Secure Callback Notifications**

The MIA POS system sends the transaction result to the `callbackUrl` as a `POST` request. The merchant must verify the signature using the public key obtained from the following endpoint:

- **Method:** `GET`
- **Endpoint:** `/ecomm/api/v1/public-key`

For more details, refer to the [Signature Verification Guide](./signature-verification.md).

---

