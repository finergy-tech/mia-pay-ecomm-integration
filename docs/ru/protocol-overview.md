# Общее описание протокола MIA POS eComm

Этот документ подробно описывает работу протокола **MIA POS eComm** и шаги, необходимые для его интеграции в системы мерчантов.

---

## Дополнительная документация

- [Документация API (скачайте и откройте в браузере)](../mia-ecomm-api_v0.0.1.html)
- [Инструкция по проверке подписи](./signature-verification.md)

---

## Поток платежа

### **1. Первоначальная настройка**

Для начала интеграции с MIA POS eComm мерчанту необходимо настроить следующие параметры в своей системе:

- **merchantId**: Уникальный идентификатор мерчанта.
- **secretKey**: Секретный ключ для аутентификации.
- **terminalId**: Идентификатор терминала для обработки платежей.
- **language**: Язык интерфейса оплаты (например: `ru`, `en`, `ro`).
- **paymentType**: Тип оплаты (`qr` для QR-кода или `rtp` для Request to Pay).
- **ecommBaseUrl**: Базовый URL для API MIA POS (например: `https://ecomm-test.miapos.md`).

---

### **2. Сбор информации о заказе**

Перед началом процесса оплаты мерчанту необходимо собрать следующую информацию о заказе:

- **orderId**: Уникальный идентификатор заказа (генерируется мерчантом).
- **amount**: Сумма платежа (в десятичном формате, например: `100.00`).
- **currency**: Валюта платежа (например: `MDL`).
- **payDescription**: Описание платежа (например: `Оплата заказа #123`).
- **clientName**: (Опционально) Имя клиента.
- **clientPhone**: (Опционально) Телефон клиента.
- **clientEmail**: (Опционально) Email клиента.

---

### **3. Инициация платежа**

Когда клиент нажимает на кнопку «Оплатить с MIA» в интернет-магазине, на стороне backend выполняются следующие шаги:

#### **3.1. Получение access token**

Если у мерчанта нет `refreshToken`, необходимо запросить пару `accessToken` и `refreshToken`, используя следующий endpoint:

- **Метод:** `POST`
- **Endpoint:** `/ecomm/api/v1/token`

#### **3.2. Обновление access token**

Если у мерчанта уже есть `refreshToken`, можно обновить `accessToken`, используя следующий endpoint:

- **Метод:** `POST`
- **Endpoint:** `/ecomm/api/v1/token/refresh`

#### **3.3. Регистрация платежа**

После получения `accessToken` мерчант должен зарегистрировать платеж, используя следующий endpoint:

- **Метод:** `POST`
- **Endpoint:** `/ecomm/api/v1/pay`

Клиент будет перенаправлен на URL `checkoutPage` для завершения оплаты.

---

### **4. Обработка результата платежа**

#### **4.1. Ошибка платежа**

Если платеж завершился с ошибкой, клиент будет перенаправлен на `failUrl`. В этом случае мерчант может проверить статус платежа, используя следующий endpoint:

- **Метод:** `GET`
- **Endpoint:** `/ecomm/api/v1/payment/{paymentId}`

#### **4.2. Успешный платеж**

Если платеж успешно завершён, клиент будет перенаправлен на `successUrl`. Мерчант должен проверить статус платежа, используя тот же endpoint:

- **Метод:** `GET`
- **Endpoint:** `/ecomm/api/v1/payment/{paymentId}`

---

### **5. Безопасные callback-уведомления**

Система MIA POS отправляет результат транзакции на `callbackUrl` в виде запроса `POST`. Мерчанту необходимо проверить подпись, используя публичный ключ, полученный через следующий endpoint:

- **Метод:** `GET`
- **Endpoint:** `/ecomm/api/v1/public-key`

Подробнее см. [Инструкцию по проверке подписи](./signature-verification.md).

---
